<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Dashboard ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ä‡πà‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    h1 {
      margin-top: 0;
      text-align: center;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .subtitle {
      text-align: center;
      margin-bottom: 16px;
    }

    /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 12px 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .card-title {
      font-size: 13px;
      color: #666;
      margin-bottom: 4px;
    }
    .card-value {
      font-size: 22px;
      font-weight: 600;
    }
    .card-note {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }

    /* ‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á */
    .charts {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.6fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    .chart-full {
      margin-top: 12px;
    }
    .panel {
      background: #ffffff;
      border-radius: 10px;
      padding: 12px 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .panel h2 {
      font-size: 16px;
      margin: 0 0 8px;
    }

    canvas {
      max-width: 100%;
    }

    /* ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î */
    .size-list {
      list-style: none;
      padding-left: 0;
      margin: 4px 0 0 0;
      font-size: 14px;
    }
    .size-list li {
      margin-bottom: 4px;
    }
    .size-label {
      display: inline-block;
      min-width: 120px;
      font-weight: 500;
    }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ / ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î */
    .simple-table,
    .due-table {
      border-collapse: collapse;
      width: 100%;
      font-size: 14px;
    }
    .simple-table th,
    .simple-table td,
    .due-table th,
    .due-table td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
      white-space: nowrap;
    }
    .simple-table th,
    .due-table th {
      background: #e3f2fd;
    }
    .simple-table tr:nth-child(even) td,
    .due-table tr:nth-child(even) td {
      background: #fafafa;
    }

    .due-badge {
      font-weight: 600;
      color: #d32f2f;
    }

    @media (max-width: 800px) {
      .charts {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>Dashboard ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ä‡πà‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</h1>
  <p class="subtitle">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏î‡∏à‡∏≤‡∏Å Google Sheets</p>

  <div class="container">

    <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ -->
    <div class="cards">
      <div class="card">
        <div class="card-title">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div class="card-value" id="totalDevices">-</div>
        <div class="card-note">‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
      </div>
      <div class="card">
        <div class="card-title">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤</div>
        <div class="card-value" id="inContract">-</div>
        <div class="card-note">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ = "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤"</div>
      </div>
      <div class="card">
        <div class="card-title">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏ß‡∏°</div>
        <div class="card-value" id="totalDays">-</div>
        <div class="card-note">‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤"</div>
      </div>
      <div class="card">
        <div class="card-title">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ / ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
        <div class="card-value" id="avgDays">-</div>
        <div class="card-note">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏ß‡∏° √∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
      </div>
    </div>

    <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏ô‡∏≤‡∏î + ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
    <div class="charts">
      <div class="panel">
        <h2>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î (‡∏•‡∏¥‡∏ï‡∏£)</h2>
        <ul class="size-list">
          <li><span class="size-label">3 ‡∏•‡∏¥‡∏ï‡∏£:</span> <span id="count3L">-</span> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</li>
          <li><span class="size-label">5 ‡∏•‡∏¥‡∏ï‡∏£:</span> <span id="count5L">-</span> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</li>
          <li><span class="size-label">10 ‡∏•‡∏¥‡∏ï‡∏£:</span> <span id="count10L">-</span> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</li>
          <li><span class="size-label">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (‡∏Ç‡∏ô‡∏≤‡∏î 0):</span> <span id="countFree">-</span> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</li>
        </ul>
        <div class="card-note" style="margin-top:8px;">
          ‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤" ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô" ‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏Ç‡∏ô‡∏≤‡∏î" (3/5/10/0)
        </div>
      </div>

      <div class="panel">
        <h2>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤ / ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ)</h2>
        <canvas id="statusChart" height="160"></canvas>
      </div>
    </div>

    <!-- üîπ Top 5 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡πÅ‡∏ó‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏î‡∏¥‡∏°) -->
    <div class="panel chart-full">
      <h2>Top 5 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤)</h2>
      <div id="topDurationBody" class="card-note">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤
      </div>
    </div>

    <!-- üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ -->
    <div class="panel chart-full" style="margin-top:16px;">
      <h2>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô)</h2>
      <div id="dueSoonBody" class="card-note">
        ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
      </div>
    </div>

  </div>

  <script>
    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/1bX4w5FDpZY4WOzl69ZJ2t8-fPtI6RKO2eIILSZ1U8Zs/export?format=csv&gid=0";

    async function loadData() {
      const res = await fetch(SHEET_CSV_URL);
      const text = await res.text();

      const rows = text.trim().split("\n").map(row => row.split(","));
      const header = rows[0];
      const dataRows = rows.slice(1);

      // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
      const idxItem     = header.indexOf("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤");
      const idxModel    = header.indexOf("‡∏£‡∏∏‡πà‡∏ô");
      const idxSize     = header.indexOf("‡∏Ç‡∏ô‡∏≤‡∏î");
      const idxStatus   = header.indexOf("‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞");
      const idxDays     = header.indexOf("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤");
      const idxMonths   = header.indexOf("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤");
      const idxPlace    = header.indexOf("‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà");
      const idxDueDate  = header.indexOf("‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î");
      const idxStart    = header.indexOf("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤");

      let totalDevices = 0;
      let inContract = 0;
      let totalDays = 0;

      const statusCounts = {};

      let count3 = 0, count5 = 0, count10 = 0, countFree = 0;

      const durationItems = [];   // ‡πÉ‡∏ä‡πâ‡∏ó‡∏≥ Top5
      const dueSoonItems = [];   // ‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î

      const today = new Date();
      today.setHours(0,0,0,0);
      const currentMonth = today.getMonth();
      const currentYear  = today.getFullYear();

      for (const row of dataRows) {
        if (row.length === 0 || row.join("").trim() === "") continue;

        totalDevices++;

        const item      = idxItem    >= 0 ? (row[idxItem]    || "").trim() : "";
        const model     = idxModel   >= 0 ? (row[idxModel]   || "").trim() : "";
        const size      = idxSize    >= 0 ? (row[idxSize]    || "").trim() : "";
        const status    = idxStatus  >= 0 ? (row[idxStatus]  || "").trim() : "";
        const daysStr   = idxDays    >= 0 ? (row[idxDays]    || "").trim() : "";
        const monthsStr = idxMonths  >= 0 ? (row[idxMonths]  || "").trim() : "";
        const place     = idxPlace   >= 0 ? (row[idxPlace]   || "").trim() : "";
        const dueStr    = idxDueDate >= 0 ? (row[idxDueDate] || "").trim() : "";
        const startStr  = idxStart   >= 0 ? (row[idxStart]   || "").trim() : "";

        // ‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        if (status) {
          statusCounts[status] = (statusCounts[status] || 0) + 1;
          if (status === "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤") inContract++;
        }

        // ‡∏ô‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô"
        if (item && item.includes("‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô")) {
          if (size === "3") count3++;
          else if (size === "5") count5++;
          else if (size === "10") count10++;
          else if (size === "0") countFree++;
        }

        // ‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πà‡∏≤ (‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á Top5)
        let days = 0;
        if (daysStr) {
          const d = Number(daysStr);
          if (!isNaN(d) && d > 0) {
            days = d;
            totalDays += d;
          }
        }

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥ Top 5 ‡πÄ‡∏ä‡πà‡∏≤‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        if (days > 0) {
          durationItems.push({
            item,
            model,
            size,
            place,
            monthsStr,
            days
          });
        }

        // ‡∏´‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ"
        if (
          item &&
          item.includes("‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô") &&
          status === "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤" &&
          dueStr &&
          startStr !== "0" &&
          !dueStr.startsWith("30/12/1899") &&
          !dueStr.startsWith("30/12/1900")
        ) {
          const parts = dueStr.split("/");
          if (parts.length === 3) {
            const [dDay, dMonth, dYear] = parts.map(Number);
            if (dYear >= 2000) {
              const dueDate = new Date(dYear, dMonth - 1, dDay);
              dueDate.setHours(0,0,0,0);

              const diffDays = Math.round((dueDate - today) / (1000*60*60*24));

              if (
                dYear === currentYear &&
                (dMonth - 1) === currentMonth &&
                diffDays >= 0
              ) {
                dueSoonItems.push({
                  item, model, size, place,
                  dueStr,
                  daysLeft: diffDays,
                  dueDate
                });
              }
            }
          }
        }
      }

      const avgDays = totalDevices > 0 ? Math.round(totalDays / totalDevices) : 0;

      // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
      document.getElementById("totalDevices").textContent = totalDevices.toLocaleString();
      document.getElementById("inContract").textContent   = inContract.toLocaleString();
      document.getElementById("totalDays").textContent    = totalDays.toLocaleString();
      document.getElementById("avgDays").textContent      = avgDays.toLocaleString();

      // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î
      document.getElementById("count3L").textContent   = count3.toLocaleString();
      document.getElementById("count5L").textContent   = count5.toLocaleString();
      document.getElementById("count10L").textContent  = count10.toLocaleString();
      document.getElementById("countFree").textContent = countFree.toLocaleString();

      // ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      buildStatusChart(statusCounts);

      // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Top 5 ‡πÄ‡∏ä‡πà‡∏≤‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
      buildTopDurationTable(durationItems);

      // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
      buildDueSoonTable(dueSoonItems);
    }

    function buildStatusChart(statusCounts) {
      const ctx = document.getElementById("statusChart").getContext("2d");
      const labels = Object.keys(statusCounts);
      const data = Object.values(statusCounts);

      new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{ data }]
        },
        options: {
          plugins: { legend: { position: "bottom" } }
        }
      });
    }

    // üîπ Top 5 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‚Äì ‡πÉ‡∏ä‡πâ days (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå M) ‡πÄ‡∏£‡∏µ‡∏¢‡∏á ‡πÅ‡∏•‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å N
    function buildTopDurationTable(items) {
      const container = document.getElementById("topDurationBody");
      if (!container) return;

      if (!items || items.length === 0) {
        container.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤";
        return;
      }

      const top = items
        .slice()
        .sort((a, b) => b.days - a.days)
        .slice(0, 5);

      const table = document.createElement("table");
      table.className = "simple-table";

      const thead = document.createElement("thead");
      const trHead = document.createElement("tr");
      ["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤", "‡∏£‡∏∏‡πà‡∏ô", "‡∏Ç‡∏ô‡∏≤‡∏î (‡∏•‡∏¥‡∏ï‡∏£)", "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤"].forEach(text => {
        const th = document.createElement("th");
        th.textContent = text;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      top.forEach(it => {
        const tr = document.createElement("tr");

        const tdItem = document.createElement("td");
        tdItem.textContent = it.item;
        tr.appendChild(tdItem);

        const tdModel = document.createElement("td");
        tdModel.textContent = it.model;
        tr.appendChild(tdModel);

        const tdSize = document.createElement("td");
        tdSize.textContent = it.size;
        tr.appendChild(tdSize);

        const tdPlace = document.createElement("td");
        tdPlace.textContent = it.place;
        tr.appendChild(tdPlace);

        const tdMonths = document.createElement("td");
        tdMonths.textContent = it.monthsStr || "-";
        tr.appendChild(tdMonths);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.innerHTML = "";
      container.appendChild(table);
    }

    // üîî ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
    function buildDueSoonTable(items) {
      const container = document.getElementById("dueSoonBody");
      if (!container) return;

      if (!items || items.length === 0) {
        container.textContent = "‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ";
        return;
      }

      items.sort((a, b) => a.dueDate - b.dueDate);

      const table = document.createElement("table");
      table.className = "due-table";

      const thead = document.createElement("thead");
      const trHead = document.createElement("tr");
      ["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤", "‡∏£‡∏∏‡πà‡∏ô", "‡∏Ç‡∏ô‡∏≤‡∏î (‡∏•‡∏¥‡∏ï‡∏£)", "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà", "‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î", "‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å (‡∏ß‡∏±‡∏ô)"].forEach(text => {
        const th = document.createElement("th");
        th.textContent = text;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      items.forEach(it => {
        const tr = document.createElement("tr");

        const tdItem = document.createElement("td");
        tdItem.textContent = it.item;
        tr.appendChild(tdItem);

        const tdModel = document.createElement("td");
        tdModel.textContent = it.model;
        tr.appendChild(tdModel);

        const tdSize = document.createElement("td");
        tdSize.textContent = it.size;
        tr.appendChild(tdSize);

        const tdPlace = document.createElement("td");
        tdPlace.textContent = it.place;
        tr.appendChild(tdPlace);

        const tdDue = document.createElement("td");
        tdDue.textContent = it.dueStr;
        tr.appendChild(tdDue);

        const tdLeft = document.createElement("td");
        tdLeft.innerHTML = `<span class="due-badge">${it.daysLeft}</span>`;
        tr.appendChild(tdLeft);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.innerHTML = "";
      container.appendChild(table);
    }

    loadData();
  </script>
</body>
</html>
