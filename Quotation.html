<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Quotation ¬∑ JP Medical So Supply</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    body {
      font-family: "TH SarabunPSK", "Sarabun", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 8px;
      background:#f5f5f5;
    }

    .page {
      max-width: 1150px;
      margin: 0 auto;
      background: #fff;
      padding: 12px 18px 18px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    .top-buttons {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      gap:8px;
      flex-wrap:wrap;
    }

    .btn {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 14px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:0.9rem;
      font-weight:600;
      font-family:inherit;
      text-decoration:none;
      color:#fff;
      background:#607d8b;
      box-shadow:0 2px 4px rgba(0,0,0,0.25);
    }
    .btn-back { background:#78909c; }
    .btn-print { background:#2196f3; }

    .btn:hover {
      transform:translateY(-1px);
      box-shadow:0 3px 6px rgba(0,0,0,0.35);
    }

    /* header */
    .header {
      border:1px solid #000;
      padding:8px 10px;
      margin-bottom:8px;
    }

    .header-top {
      display:flex;
      align-items:flex-start;
      gap:10px;
    }

    .logo-box {
      flex:0 0 110px;
      text-align:center;
    }

    .logo-box img {
      max-width:100%;
      height:auto;
    }

    .company-info {
      flex:1;
      font-size:15px;
      line-height:1.35;
    }

    .company-name {
      font-size:18px;
      font-weight:bold;
    }

    .branch-line {
      margin-top:2px;
      font-size:14px;
    }

    .branch-select-row {
      margin-top:4px;
      font-size:14px;
    }

    .branch-select-row select {
      font-family:inherit;
      font-size:14px;
      padding:2px 4px;
    }

    .quo-title-box {
      text-align:center;
      border-top:1px solid #000;
      margin-top:6px;
      padding-top:6px;
    }

    .quo-main-title {
      font-size:22px;
      font-weight:bold;
      letter-spacing:.06em;
    }

    .quo-sub-title {
      font-size:16px;
    }

    /* customer + quote info */
    .info-row {
      display:grid;
      grid-template-columns: 1.6fr 1.1fr;
      gap:8px;
      margin-top:8px;
    }

    .panel {
      border:1px solid #000;
      padding:6px 8px;
      font-size:14px;
      min-height:88px;
    }

    .panel-title {
      font-weight:600;
      margin-bottom:4px;
    }

    .panel label {
      display:inline-block;
      min-width:80px;
    }

    input[type="text"],
    input[type="number"],
    textarea {
      font-family:inherit;
      font-size:14px;
      padding:2px 4px;
      border:1px solid #b0bec5;
      border-radius:4px;
      box-sizing:border-box;
    }

    input[type="text"], input[type="number"] {
      height:24px;
    }

    .w-100 { width:100%; }
    .w-60  { width:60%;  }
    .w-40  { width:40%;  }
    .w-30  { width:30%;  }
    .w-20  { width:20%;  }

    /* table items */
    .table-wrapper {
      border:1px solid #000;
      margin-top:10px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }

    th, td {
      border:1px solid #000;
      padding:2px 4px;
      vertical-align:top;
    }

    thead th {
      text-align:center;
      background:#4caf50;
      color:#fff;
    }

    tbody td {
      height:24px;
    }

    .center { text-align:center; }
    .right  { text-align:right; }

    .no-input {
      width:100%;
      border:none;
      text-align:center;
      background:transparent;
    }

    .item-code-input,
    .desc-input,
    .qty-input,
    .unit-input,
    .price-input {
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      box-sizing:border-box;
    }

    .qty-input,
    .price-input {
      text-align:right;
    }

    .amount-cell {
      text-align:right;
      white-space:nowrap;
      padding-right:6px;
    }

    .summary-row {
      margin-top:6px;
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:8px;
    }

    .note-box {
      border:1px solid #000;
      min-height:72px;
      padding:4px 6px;
      font-size:13px;
    }

    .summary-box {
      border:1px solid #000;
      font-size:13px;
    }

    .summary-box table {
      width:100%;
      border-collapse:collapse;
    }
    .summary-box td {
      border:none;
      padding:2px 4px;
    }

    .summary-box td.label {
      width:55%;
    }
    .summary-box td.value {
      width:45%;
      text-align:right;
      padding-right:6px;
      white-space:nowrap;
    }

    #amountText {
      font-size:13px;
      padding:2px 6px 4px;
      border-top:1px solid #000;
    }

    /* footer sign section: 3 parts equal */
    .sign-wrap {
      margin-top:8px;
    }

    .sign-table {
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }

    .sign-table td {
      border-top:1px solid #000;
      border-left:1px solid #000;
      padding:8px 6px 12px;
      font-size:13px;
      vertical-align:top;
    }

    .sign-table td:first-child {
      border-left:none;
    }

    .sign-note {
      font-size:13px;
      line-height:1.4;
    }

    .sign-note small {
      font-size:12px;
    }

    .sign-name-line {
      margin-top:18px;
      text-align:center;
    }

    .sign-name-line span {
      display:inline-block;
      border-bottom:1px solid #000;
      min-width:160px;
      padding-bottom:2px;
    }

    .sign-label {
      margin-top:4px;
      font-size:13px;
      text-align:center;
    }

    .qr-title {
      text-align:center;
      font-size:13px;
      margin-bottom:6px;
    }

    .qr-img {
      display:block;
      margin:0 auto;
      width:110px;
      height:auto;
    }

    .qr-caption {
      text-align:center;
      font-size:11px;
      margin-top:4px;
    }

    .status-row {
      margin-top:4px;
      font-size:11px;
      color:#555;
      text-align:left;
    }

    /* ‡∏ã‡πà‡∏≠‡∏ô placeholder ‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå */
    @media print {
      input::placeholder,
      textarea::placeholder {
        color: transparent !important;
      }

      body {
        padding:0;
        background:#fff;
      }
      .page {
        margin:0;
        box-shadow:none;
        padding:0 6mm 6mm;
      }
      .top-buttons {
        display:none;
      }
      @page {
        size:A4 portrait;
        margin:5mm;
      }
    }
  </style>
</head>

<body>
<div class="page">

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ô -->
  <div class="top-buttons">
    <a href="ky9.html" class="btn btn-back">‚Üê ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏Ç‡∏¢.9)</a>
    <button class="btn btn-print" onclick="window.print()">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå / PDF</button>
  </div>

  <!-- header ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó -->
  <div class="header">
    <div class="header-top">
      <div class="logo-box">
        <img src="LOGO.jpg" alt="JP Medical So Supply Logo">
      </div>
      <div class="company-info">
        <div class="company-name" id="companyName">
          ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÄ‡∏à‡∏û‡∏µ ‡πÄ‡∏°‡∏î‡∏¥‡∏Ñ‡∏≠‡∏• ‡πÇ‡∏ã ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢ (‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà)
        </div>
        <div id="companyAddr">
          ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 871/1 ‡∏ñ‡∏ô‡∏ô‡∏≠‡∏∏‡∏ö‡∏• ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÉ‡∏ï‡πâ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏© 33000
        </div>
        <div id="companyTel">
          ‡πÇ‡∏ó‡∏£ 090-413 7894, 090-967 4207
        </div>
        <div class="branch-select-row">
          ‡∏™‡∏≤‡∏Ç‡∏≤:
          <select id="branchSelect">
            <option value="hq">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà (‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©)</option>
            <option value="chon">‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</option>
          </select>
        </div>
      </div>
    </div>

    <div class="quo-title-box">
      <div class="quo-main-title">QUOTATION</div>
      <div class="quo-sub-title">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</div>
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ -->
  <div class="info-row">
    <!-- customer -->
    <div class="panel">
      <div class="panel-title">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Customer)</div>
      <div>
        ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:
        <input id="custName" type="text" class="w-60" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô">
      </div>
      <div style="margin-top:2px;">
        ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô / ‡∏£‡πâ‡∏≤‡∏ô:
        <input id="custOrg" type="text" class="w-60">
      </div>
      <div style="margin-top:2px;">
        ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:
        <input id="custAddr" type="text" class="w-100">
      </div>
      <div style="margin-top:2px;">
        ‡πÇ‡∏ó‡∏£:
        <input id="custTel" type="text" class="w-40">
      </div>
    </div>

    <!-- quote info -->
    <div class="panel">
      <div class="panel-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</div>
      <div>
        ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤:
        <input id="quoNo" type="text" class="w-60">
      </div>
      <div style="margin-top:2px;">
        ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:
        <input id="quoDate" type="text" class="w-40">
      </div>
      <div style="margin-top:2px;">
        ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:
        <input id="validDate" type="text" class="w-40">
      </div>
      <div style="margin-top:2px;">
        ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:
        <input id="contactName" type="text" class="w-60" value="‡∏û‡∏±‡∏í‡∏ô‡πå‡∏ô‡∏£‡∏µ ‡πÇ‡∏û‡∏ò‡∏¥‡∏£‡∏≤‡∏ä">
      </div>
      <div style="margin-top:2px;">
        ‡πÇ‡∏ó‡∏£:
        <input id="contactTel" type="text" class="w-60" value="090-413-7894, 090-967-4207">
      </div>
    </div>
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th style="width:5%;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th style="width:13%;">Item Code</th>
          <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
          <th style="width:7%;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th style="width:8%;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <th style="width:12%;">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <th style="width:12%;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
        </tr>
      </thead>
      <tbody id="itemBody">
        <!-- 10 ‡πÅ‡∏ñ‡∏ß‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á -->
        <!-- ‡∏à‡∏∞‡∏ß‡∏ô‡πÉ‡∏ô JS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà event -->
        ${[...Array(10)].map((_,i)=>`
        <tr class="item-row">
          <td class="center">
            <input class="no-input" type="text" value="${i+1}">
          </td>
          <td>
            <input class="item-code-input" type="text" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
          </td>
          <td>
            <input class="desc-input" type="text"
                   placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏ß‡∏î / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
                   list="productList">
          </td>
          <td>
            <input class="qty-input" type="number" min="0" step="1" placeholder="1">
          </td>
          <td>
            <input class="unit-input" type="text" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢">
          </td>
          <td>
            <input class="price-input" type="number" min="0" step="0.01" placeholder="0.00">
          </td>
          <td class="amount-cell">
            <span class="amount-text">0.00</span>
          </td>
        </tr>
        `).join("")}
      </tbody>
    </table>
  </div>

  <!-- datalist ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
  <datalist id="productList"></datalist>

  <!-- ‡∏™‡∏£‡∏∏‡∏õ+‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ -->
  <div class="summary-row">
    <div class="note-box">
      ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤:<br>
      <textarea id="note" class="w-100" rows="3"
        placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ‡∏Ø‡∏•‡∏Ø"></textarea>
    </div>
    <div class="summary-box">
      <table>
        <tr>
          <td class="label">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</td>
          <td class="value"><span id="subTotal">0.00</span></td>
        </tr>
        <tr>
          <td class="label">
            ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
            <input id="discount" type="number" step="0.01" class="w-40" value="0">
          </td>
          <td class="value"><span id="discountShow">0.00</span></td>
        </tr>
        <tr>
          <td class="label">
            ‡∏´‡∏±‡∏Å ‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
            <input id="deposit" type="number" step="0.01" class="w-40" value="0">
          </td>
          <td class="value"><span id="depositShow">0.00</span></td>
        </tr>
        <tr>
          <td class="label">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</td>
          <td class="value"><span id="grandTotal">0.00</span></td>
        </tr>
      </table>
      <div id="amountText">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£): -</div>
    </div>
  </div>

  <!-- ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô + QR -->
  <div class="sign-wrap">
    <table class="sign-table">
      <tr>
        <td>
          <div class="sign-note">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ<br>
            <small>Please sign below purchasing confirmation.</small>
          </div>
          <div class="sign-name-line">
            <span>( .................................................. )</span>
          </div>
          <div class="sign-label">‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
        </td>
        <td>
          <div class="sign-name-line">
            <span>( ‡∏û‡∏±‡∏í‡∏ô‡πå‡∏ô‡∏£‡∏µ ‡πÇ‡∏û‡∏ò‡∏¥‡∏£‡∏≤‡∏ä )</span>
          </div>
          <div class="sign-label">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ / Prepared by</div>
        </td>
        <td>
          <div class="qr-title">
            ‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏∑‡∏≠<br>
            JP Medical So Supply
          </div>
          <img src="ORCODE%20OFFice.png" alt="Line QR" class="qr-img">
          <div class="qr-caption">
            ‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏° / ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          </div>
        </td>
      </tr>
    </table>
  </div>

  <div id="status" class="status-row">
    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Google Sheet‚Ä¶
  </div>

</div> <!-- page -->

<script>
  /* ---------- ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà Google Sheet ---------- */
  const PRODUCT_SHEET_ID = "1U4d5PqBMQ1GfTahwvbvzDFQrEikT5sYCOwZIx8FabMI";
  const PRODUCT_GID = "942187814";
  const PRODUCT_URL =
    `https://docs.google.com/spreadsheets/d/${PRODUCT_SHEET_ID}/gviz/tq?tqx=out:json&gid=${PRODUCT_GID}`;

  let products = [];

  /* ---------- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ---------- */
  function pad2(n){ return n.toString().padStart(2,"0"); }

  function formatDate(d){
    const day = pad2(d.getDate());
    const month = pad2(d.getMonth()+1);
    const year = d.getFullYear()+543; // ‡∏û.‡∏®.
    return `${day}/${month}/${year}`;
  }

  function addDays(d, days){
    const nd = new Date(d.getTime());
    nd.setDate(nd.getDate()+days);
    return nd;
  }

  /* ---------- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏£‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ---------- */
  function generateQuotationNo(){
    const today = new Date();
    const y = today.getFullYear().toString().slice(-2);
    const m = pad2(today.getMonth()+1);
    const d = pad2(today.getDate());
    let seq = Number(localStorage.getItem("jpms_qt_seq") || "0") + 1;
    localStorage.setItem("jpms_qt_seq", seq.toString());
    const seqStr = seq.toString().padStart(3,"0");
    return `QT-${y}${m}${d}-${seqStr}`;
  }

  /* ---------- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤ ---------- */
  const branchData = {
    hq: {
      name: "‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÄ‡∏à‡∏û‡∏µ ‡πÄ‡∏°‡∏î‡∏¥‡∏Ñ‡∏≠‡∏• ‡πÇ‡∏ã ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢ (‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà)",
      addr: "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 871/1 ‡∏ñ‡∏ô‡∏ô‡∏≠‡∏∏‡∏ö‡∏• ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÉ‡∏ï‡πâ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏© 33000",
      tel:  "‡πÇ‡∏ó‡∏£ 090-413 7894, 090-967 4207",
    },
    chon: {
      name: "‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÄ‡∏à‡∏û‡∏µ ‡πÄ‡∏°‡∏î‡∏¥‡∏Ñ‡∏≠‡∏• ‡πÇ‡∏ã ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢ ‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ",
      addr: "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 51/49 ‡∏ñ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó ‡∏´‡∏°‡∏π‡πà 4 ‡∏ï‡∏≥‡∏ö‡∏•‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏ß‡∏ô ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ 20000",
      tel:  "‡πÇ‡∏ó‡∏£ 090-413 7894, 090-967 4207",
    }
  };

  function applyBranch(branch){
    const data = branchData[branch] || branchData.hq;
    document.getElementById("companyName").textContent = data.name;
    document.getElementById("companyAddr").textContent = data.addr;
    document.getElementById("companyTel").textContent = data.tel;
  }

  /* ---------- ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Google Sheet ---------- */
  async function loadProducts(){
    const status = document.getElementById("status");
    try{
      const res = await fetch(PRODUCT_URL);
      if(!res.ok){
        throw new Error("HTTP " + res.status + " " + res.statusText);
      }
      const text = await res.text();
      const jsonStr = text.substring(text.indexOf("{"), text.lastIndexOf("}")+1);
      const data = JSON.parse(jsonStr);
      const rows = data.table.rows || [];

      products = rows.map(r => {
        const c = r.c || [];
        return {
          itemCode: c[0]?.v ?? "",
          productName: c[1]?.v ?? "",
          category: c[2]?.v ?? "",
          unit: c[3]?.v ?? "",
          cost: Number(c[5]?.v ?? 0)
        };
      }).filter(p => p.itemCode || p.productName);

      buildProductDatalist();

      status.textContent =
        `‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ${products.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÑ‡∏î‡πâ`;
    }catch(e){
      console.error(e);
      let msg = "‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      if(String(e).includes("403")){
        msg += " (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ä‡∏µ‡∏ï‡πÄ‡∏õ‡πá‡∏ô Anyone with the link ‚Äì Viewer)";
      }
      status.textContent = msg + " ‚Äì ‡∏¢‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ";
    }
  }

  function buildProductDatalist(){
    const dl = document.getElementById("productList");
    dl.innerHTML = "";
    products.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = `${p.category} | ${p.productName} | ${p.itemCode}`;
      dl.appendChild(opt);
    });
  }

  /* ---------- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ---------- */
  function findProductByCode(code){
    if(!code) return null;
    return products.find(p => p.itemCode === code.trim());
  }

  function findProductFromDesc(desc){
    if(!desc) return null;
    const t = desc.trim();
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö category | name | code
    const parts = t.split("|").map(s=>s.trim());
    const codeFromStr = parts[2];
    if(codeFromStr){
      const byCode = findProductByCode(codeFromStr);
      if(byCode) return byCode;
    }
    // ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠
    return products.find(p => p.productName === t || t.includes(p.itemCode));
  }

  function bindRowEvents(){
    const rows = document.querySelectorAll(".item-row");
    rows.forEach(row=>{
      const noInput    = row.querySelector(".no-input");
      const codeInput  = row.querySelector(".item-code-input");
      const descInput  = row.querySelector(".desc-input");
      const qtyInput   = row.querySelector(".qty-input");
      const unitInput  = row.querySelector(".unit-input");
      const priceInput = row.querySelector(".price-input");

      // ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
      noInput.addEventListener("input", ()=>{
        if(noInput.value && isNaN(Number(noInput.value))){
          noInput.value = "";
        }
      });

      // ‡∏à‡∏≤‡∏Å code ‚Üí ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      codeInput.addEventListener("change", ()=>{
        const p = findProductByCode(codeInput.value);
        if(p){
          fillRowFromProduct(row, p);
        }
        recalcRow(row);
      });

      // ‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Üí ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      descInput.addEventListener("change", ()=>{
        const p = findProductFromDesc(descInput.value);
        if(p){
          fillRowFromProduct(row, p);
        }
        recalcRow(row);
      });

      // qty / price ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Üí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
      ["input","change"].forEach(ev=>{
        qtyInput.addEventListener(ev, ()=>recalcRow(row));
        priceInput.addEventListener(ev, ()=>recalcRow(row));
      });
    });
  }

  function fillRowFromProduct(row, p){
    const codeInput  = row.querySelector(".item-code-input");
    const descInput  = row.querySelector(".desc-input");
    const qtyInput   = row.querySelector(".qty-input");
    const unitInput  = row.querySelector(".unit-input");
    const priceInput = row.querySelector(".price-input");

    codeInput.value  = p.itemCode;
    descInput.value  = p.productName;
    unitInput.value  = p.unit || "";
    if(!qtyInput.value) qtyInput.value = "1";
    if(p.cost){
      priceInput.value = p.cost.toFixed(2);
    }
  }

  /* ---------- ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î / ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ---------- */
  function recalcRow(row){
    const qty   = Number(row.querySelector(".qty-input").value || 0);
    const price = Number(row.querySelector(".price-input").value || 0);
    const amount = qty * price;
    row.querySelector(".amount-text").textContent = amount.toFixed(2);
    recalcSummary();
  }

  function recalcSummary(){
    const rows = document.querySelectorAll(".item-row");
    let subtotal = 0;
    rows.forEach(row=>{
      const amt = Number(row.querySelector(".amount-text").textContent || 0);
      subtotal += amt;
    });

    const discount = Number(document.getElementById("discount").value || 0);
    const deposit  = Number(document.getElementById("deposit").value  || 0);

    const afterDiscount = subtotal - discount;
    const grand = afterDiscount - deposit;

    document.getElementById("subTotal").textContent   = subtotal.toFixed(2);
    document.getElementById("discountShow").textContent = discount.toFixed(2);
    document.getElementById("depositShow").textContent  = deposit.toFixed(2);
    document.getElementById("grandTotal").textContent   = grand.toFixed(2);

    document.getElementById("amountText").textContent =
      "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£): " + (grand > 0 ? thaiBahtText(grand) : "-");
  }

  document.getElementById("discount").addEventListener("input", recalcSummary);
  document.getElementById("deposit").addEventListener("input", recalcSummary);

  /* ---------- ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡∏ö‡∏≤‡∏ó) ---------- */
  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
  function thaiBahtText(amount){
    amount = Math.round(amount * 100) / 100; // ‡∏õ‡∏±‡∏î‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    const number = Math.floor(amount);
    const satang = Math.round((amount - number) * 100);

    if(number === 0 && satang === 0) return "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏ó‡∏ñ‡πâ‡∏ß‡∏ô";

    const digits = ["‡∏®‡∏π‡∏ô‡∏¢‡πå","‡∏´‡∏ô‡∏∂‡πà‡∏á","‡∏™‡∏≠‡∏á","‡∏™‡∏≤‡∏°","‡∏™‡∏µ‡πà","‡∏´‡πâ‡∏≤","‡∏´‡∏Å","‡πÄ‡∏à‡πá‡∏î","‡πÅ‡∏õ‡∏î","‡πÄ‡∏Å‡πâ‡∏≤"];
    const units  = ["","‡∏™‡∏¥‡∏ö","‡∏£‡πâ‡∏≠‡∏¢","‡∏û‡∏±‡∏ô","‡∏´‡∏°‡∏∑‡πà‡∏ô","‡πÅ‡∏™‡∏ô","‡∏•‡πâ‡∏≤‡∏ô"];

    function readNumber(n){
      if(n === 0) return "";
      let text = "";
      const numStr = n.toString();
      const len = numStr.length;

      for(let i=0;i<len;i++){
        const digit = Number(numStr.charAt(i));
        const pos = len - i - 1;
        if(digit === 0) continue;

        if(pos === 0){ // ‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢
          if(digit === 1 && len > 1){
            text += "‡πÄ‡∏≠‡πá‡∏î";
          }else{
            text += digits[digit];
          }
        }else if(pos === 1){ // ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö
          if(digit === 1){
            text += "‡∏™‡∏¥‡∏ö";
          }else if(digit === 2){
            text += "‡∏¢‡∏µ‡πà‡∏™‡∏¥‡∏ö";
          }else{
            text += digits[digit] + "‡∏™‡∏¥‡∏ö";
          }
        }else{
          text += digits[digit] + units[pos];
        }
      }
      return text;
    }

    let bahtText = "";
    let n = number;
    let level = 0;

    while(n > 0){
      const part = n % 1000000;
      if(part !== 0){
        const partText = readNumber(part);
        if(level > 0){
          bahtText = partText + "‡∏•‡πâ‡∏≤‡∏ô" + bahtText;
        }else{
          bahtText = partText + bahtText;
        }
      }
      n = Math.floor(n / 1000000);
      level++;
    }

    bahtText += "‡∏ö‡∏≤‡∏ó";

    if(satang === 0){
      bahtText += "‡∏ñ‡πâ‡∏ß‡∏ô";
    }else{
      bahtText += readNumber(satang) + "‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå";
    }
    return bahtText;
  }

  /* ---------- initial ---------- */
  window.addEventListener("DOMContentLoaded", ()=>{
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤
    const branchSelect = document.getElementById("branchSelect");
    branchSelect.addEventListener("change", ()=>applyBranch(branchSelect.value));
    applyBranch(branchSelect.value);

    // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà + ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
    const today = new Date();
    document.getElementById("quoDate").value  = formatDate(today);
    document.getElementById("validDate").value = formatDate(addDays(today, 30));
    document.getElementById("quoNo").value    = generateQuotationNo();

    // bind row events
    bindRowEvents();
    recalcSummary();

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    loadProducts();
  });
</script>
</body>
</html>
