<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ¬∑ JP Medical So Supply</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    body{
      margin:0;
      padding:8px;
      font-family:"TH SarabunPSK","Sarabun",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f5f5f5;
    }
    .jp-page{
      max-width:1120px;
      margin:0 auto;
      background:#fff;
      padding:16px 20px 24px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
    }

    /* ‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
    .jp-header{
      border-bottom:3px solid #16a34a;
      padding-bottom:8px;
      margin-bottom:10px;
    }
    .jp-header-inner{
      display:flex;
      align-items:flex-start;
      gap:12px;
    }
    .jp-logo{
      height:70px;
      width:auto;
    }
    .jp-header-text{
      flex:1;
      min-width:0;
    }
    .jp-branch-row{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:6px;
      font-size:13px;
    }
    #jpBranchSelect{
      font-size:13px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid #cbd5e1;
      background:#f9fafb;
    }
    .jp-header-main{
      font-size:18px;
      font-weight:700;
      color:#14532d;
    }
    .jp-header-sub{
      font-size:14px;
      line-height:1.4;
    }
    .jp-doc-title-box{
      text-align:right;
      font-size:14px;
    }
    .jp-doc-title{
      font-weight:700;
      font-size:18px;
    }
    .jp-doc-subtitle{
      font-size:13px;
      color:#4b5563;
    }

    /* ‡πÅ‡∏ñ‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
    .top-buttons{
      display:flex;
      gap:8px;
      margin:10px 0 8px;
      flex-wrap:wrap;
    }
    .btn{
      border-radius:999px;
      border:none;
      padding:4px 14px;
      font-size:14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      background:#e5e7eb;
    }
    .btn-primary{
      background:#0ea5e9;
      color:#fff;
    }
    .btn-back{
      background:#cbd5e1;
    }

    .jp-content{
      margin-top:4px;
      font-size:14px;
    }

    .info-row{
      display:grid;
      grid-template-columns: minmax(0,1.3fr) minmax(0,1fr);
      gap:8px;
      margin-bottom:10px;
    }
    .info-box{
      border:1px solid #d4d4d8;
      border-radius:10px;
      padding:8px 10px;
      min-height:90px;
    }
    .info-title{
      font-weight:600;
      margin-bottom:4px;
    }
    .editable-inline{
      border-bottom:1px dotted #999;
      min-width:60px;
      display:inline-block;
      padding:0 2px;
    }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ */
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    th,td{
      border:1px solid #9ca3af;
      padding:3px 4px;
      vertical-align:top;
      white-space:nowrap;
    }
    thead th{
      background:#16a34a;
      color:#fff;
      text-align:center;
    }
    .col-no{ width:32px; text-align:center; }
    .col-code{ width:110px; }
    .col-desc{ width:260px; }
    .col-cat{  width:140px; }
    .col-qty{  width:60px; text-align:center; }
    .col-unit{ width:80px; text-align:center; }
    .col-price{width:95px; text-align:right;}
    .col-amount{width:110px; text-align:right;}

    .product-search{
      width:100%;
      border:1px solid #cbd5e1;
      border-radius:6px;
      padding:2px 4px;
      font-family:inherit;
      font-size:13px;
    }
    .qty-input,
    .price-input{
      width:100%;
      border:1px solid #cbd5e1;
      border-radius:6px;
      padding:2px 4px;
      font-family:inherit;
      font-size:13px;
      text-align:right;
    }
    .qty-input{
      text-align:center;
    }

    /* ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤ */
    .summary-row{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
    }
    .summary-table{
      font-size:14px;
      border-collapse:collapse;
      min-width:260px;
    }
    .summary-table td{
      border:1px solid #d4d4d8;
      padding:3px 6px;
      white-space:nowrap;
    }
    .summary-table td:first-child{
      text-align:right;
      background:#f3f4f6;
    }
    .summary-input{
      width:100%;
      border:none;
      text-align:right;
      font-family:inherit;
      font-size:14px;
      padding:0;
    }
    .summary-value{
      text-align:right;
      min-width:90px;
    }

    /* ‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© / ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô */
    .jp-footer{
      margin-top:18px;
      font-size:13px;
    }
    .jp-sign-row{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
    }
    .jp-sign-block{
      flex:1 1 260px;
      border:1px solid #cbd5e1;
      border-radius:10px;
      padding:10px 12px 12px;
      min-height:120px;
    }
    .jp-sign-title{ font-weight:600; margin-bottom:4px; }
    .jp-sign-company{ font-weight:600; margin-bottom:6px; }
    .jp-sign-line{ margin:18px 0 2px; }
    .jp-sign-line span{
      border-bottom:1px solid #000;
      min-width:180px;
      display:inline-block;
    }
    .jp-sign-label{
      font-size:12px;
      color:#4b5563;
    }
    .jp-sign-note{
      margin-top:8px;
      font-size:12px;
    }

    @media print{
      body{background:#fff;padding:0;}
      .jp-page{
        box-shadow:none;
        margin:0;
        padding:4mm 6mm 6mm;
      }
      .top-buttons{ display:none; }
      @page{
        size:A4 portrait;
        margin:6mm;
      }
    }
  </style>
</head>
<body>
<div class="jp-page">

  <!-- ‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© -->
  <header class="jp-header">
    <div class="jp-header-inner">
      <img src="LOGO.jpg" alt="JP Logo" class="jp-logo">

      <div class="jp-header-text">
        <div class="jp-branch-row">
          <label for="jpBranchSelect">‡∏™‡∏≤‡∏Ç‡∏≤:</label>
          <select id="jpBranchSelect">
            <option value="hq">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà (‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©)</option>
            <option value="chonburi">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</option>
          </select>
        </div>
        <div id="jpHeaderMain" class="jp-header-main"></div>
        <div id="jpHeaderSub"  class="jp-header-sub"></div>
      </div>

      <div class="jp-doc-title-box">
        <div id="jpDocTitle" class="jp-doc-title">QUOTATION</div>
        <div id="jpDocSubtitle" class="jp-doc-subtitle">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</div>
      </div>
    </div>
  </header>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
  <div class="top-buttons">
    <button class="btn btn-back" onclick="window.location.href='ky9.html'">
      ‚Üê ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏Ç‡∏¢.9)
    </button>
    <button class="btn btn-primary" onclick="window.print()">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå / PDF</button>
  </div>

  <div class="jp-content">

    <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ -->
    <div class="info-row">
      <div class="info-box">
        <div class="info-title">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Customer)</div>
        <div>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: <span contenteditable="true" class="editable-inline"></span></div><br>
        <div>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô / ‡∏£‡πâ‡∏≤‡∏ô: <span contenteditable="true" class="editable-inline"></span></div><br>
        <div>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: <span contenteditable="true" class="editable-inline" style="min-width:260px;"></span></div><br>
        <div>‡πÇ‡∏ó‡∏£: <span contenteditable="true" class="editable-inline"></span></div>
      </div>

      <div class="info-box">
        <div class="info-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</div>
        <div>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤: <span id="qtNumber" class="editable-inline" contenteditable="true"></span></div>
        <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="qtDate" class="editable-inline" contenteditable="true"></span></div>
        <div>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="qtValidUntil" class="editable-inline" contenteditable="true"></span></div>
        <div>‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: <span contenteditable="true" class="editable-inline">‡∏Ñ‡∏∏‡∏ì‡∏û‡∏±‡∏í‡∏ô‡πå‡∏ô‡∏£‡∏µ</span></div>
        <div>‡πÇ‡∏ó‡∏£: <span contenteditable="true" class="editable-inline">090-413-7894, 090-967-4207</span></div>
      </div>
    </div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
    <table>
      <thead>
        <tr>
          <th class="col-no">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th class="col-code">Item Code</th>
          <th class="col-desc">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
          <th class="col-cat">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
          <th class="col-qty">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th class="col-unit">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <th class="col-price">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <th class="col-amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
        </tr>
      </thead>
      <tbody id="itemsBody"></tbody>
    </table>

    <!-- datalist ‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
    <datalist id="productList"></datalist>

    <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤ -->
    <div class="summary-row">
      <table class="summary-table">
        <tr>
          <td>‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</td>
          <td class="summary-value" id="subtotal">0.00</td>
        </tr>
        <tr>
          <td>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</td>
          <td>
            <input id="discountInput" type="number" step="0.01"
                   class="summary-input" value="0" />
          </td>
        </tr>
        <tr>
          <td>‡∏°‡∏±‡∏î‡∏à‡∏≥ / ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</td>
          <td>
            <input id="depositInput" type="number" step="0.01"
                   class="summary-input" value="0" />
          </td>
        </tr>
        <tr>
          <td><strong>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</strong></td>
          <td class="summary-value" id="grandTotal"><strong>0.00</strong></td>
        </tr>
      </table>
    </div>

    <!-- ‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© / ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô -->
    <footer class="jp-footer">
      <div class="jp-sign-row">
        <div class="jp-sign-block">
          <div class="jp-sign-title">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
          <div class="jp-sign-line">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ <span></span></div>
          <div class="jp-sign-label">(‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ / ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)</div>
          <div class="jp-sign-line">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span></span></div>
        </div>

        <div class="jp-sign-block">
          <div class="jp-sign-title">‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏∑‡∏≠</div>
          <div class="jp-sign-company">JP Medical So Supply</div>
          <div class="jp-sign-line">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ <span></span></div>
          <div class="jp-sign-label">(‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ / Prepared by)</div>
          <div class="jp-sign-note">
            ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥: ‡∏Ñ‡∏∏‡∏ì‡∏û‡∏±‡∏í‡∏ô‡πå‡∏ô‡∏£‡∏µ<br>
            ‡πÇ‡∏ó‡∏£: 090-413-7894, 090-967-4207
          </div>
        </div>
      </div>
    </footer>

  </div>
</div>

<script>
/* ======================= ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ + ‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© ======================= */
const JP_BRANCHES = {
  hq:{
    name:"‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÄ‡∏à‡∏û‡∏µ ‡πÄ‡∏°‡∏î‡∏¥‡∏Ñ‡∏≠‡∏• ‡πÇ‡∏ã ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢ (‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà)",
    addr:"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 871/1 ‡∏ñ‡∏ô‡∏ô‡∏≠‡∏∏‡∏ö‡∏• ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÉ‡∏ï‡πâ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏© 33000",
    tel:"‡πÇ‡∏ó‡∏£ 090-413-7894, 090-967-4207"
  },
  chonburi:{
    name:"‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÄ‡∏à‡∏û‡∏µ ‡πÄ‡∏°‡∏î‡∏¥‡∏Ñ‡∏≠‡∏• ‡πÇ‡∏ã ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢ (‡∏™‡∏≤‡∏Ç‡∏≤‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ)",
    addr:"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 51/49 ‡∏ñ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó ‡∏´‡∏°‡∏π‡πà 4 ‡∏ï‡∏≥‡∏ö‡∏•‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏ß‡∏ô ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ 20000",
    tel:"‡πÇ‡∏ó‡∏£ 090-413-7894, 090-967-4207"
  }
};

function jpApplyBranch(branchKey){
  const b = JP_BRANCHES[branchKey] || JP_BRANCHES.hq;
  const mainEl = document.getElementById("jpHeaderMain");
  const subEl  = document.getElementById("jpHeaderSub");
  if(mainEl) mainEl.textContent = b.name;
  if(subEl)  subEl.innerHTML = b.addr + "<br>" + b.tel;
  try{ localStorage.setItem("JP_BRANCH", branchKey); }catch(e){}
}

function jpInitHeader(){
  const selectEl = document.getElementById("jpBranchSelect");
  let saved = "hq";
  try{
    const v = localStorage.getItem("JP_BRANCH");
    if(v && JP_BRANCHES[v]) saved = v;
  }catch(e){}
  if(selectEl){
    selectEl.value = saved;
    selectEl.addEventListener("change", ()=>jpApplyBranch(selectEl.value));
  }
  jpApplyBranch(saved);
}

/* ======================= ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ + ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ======================= */
function pad(n){ return n.toString().padStart(2,"0"); }

function initQuotationMeta(){
  const now = new Date();
  const y = now.getFullYear();
  const m = pad(now.getMonth()+1);
  const d = pad(now.getDate());

  const qtDateEl = document.getElementById("qtDate");
  const validEl  = document.getElementById("qtValidUntil");
  const numEl    = document.getElementById("qtNumber");

  if(qtDateEl && !qtDateEl.textContent.trim()){
    qtDateEl.textContent = `${d}/${m}/${y + 543}`; // ‡πÅ‡∏™‡∏î‡∏á ‡∏û.‡∏®.
  }

  if(validEl && !validEl.textContent.trim()){
    const validDate = new Date(now.getTime() + 30*24*60*60*1000);
    const vy = validDate.getFullYear();
    const vm = pad(validDate.getMonth()+1);
    const vd = pad(validDate.getDate());
    validEl.textContent = `${vd}/${vm}/${vy + 543}`;
  }

  if(numEl && !numEl.textContent.trim()){
    // RUN ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà QT ‡∏ï‡∏≤‡∏°‡∏õ‡∏µ-‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    const key = "JP_QT_RUN_" + y + m;
    let run = 1;
    try{
      const last = localStorage.getItem(key);
      if(last) run = Number(last) + 1;
      localStorage.setItem(key, run.toString());
    }catch(e){}
    const runStr = run.toString().padStart(3,"0");
    numEl.textContent = `QT-${y}${m}-${runStr}`;
  }
}

/* ======================= ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏à‡∏≤‡∏Å Google Sheet ======================= */
const SPREADSHEET_ID ="1U4d5PqBMQ1GfTahwvbvzDFQrEikT5sYCOwZIx8FabMI";
const GID_PRODUCTS    ="942187814";
const URL_PRODUCTS =`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${GID_PRODUCTS}`;

let PRODUCTS = [];

function parseProductRow(row){
  const c = row.c || [];
  return {
    code:     (c[0]?.v || "").toString().trim(), // ITEMCODE
    name:     (c[1]?.v || "").toString().trim(),
    category: (c[2]?.v || "").toString().trim(),
    unit:     (c[3]?.v || "").toString().trim(),
    cost:     Number(c[5]?.v || 0)              // cost_price_per_unit (F)
  };
}

async function loadProducts(){
  try{
    const res  = await fetch(URL_PRODUCTS);
    const text = await res.text();
    const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}")+1));
    const rows = json.table.rows || [];
    // ‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á 1 ‡πÅ‡∏ñ‡∏ß
    PRODUCTS = rows.slice(1).map(parseProductRow);
    buildProductDatalist();
  }catch(e){
    console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", e);
  }
}

function buildProductDatalist(){
  const dl = document.getElementById("productList");
  if(!dl) return;
  dl.innerHTML = "";
  PRODUCTS.forEach(p=>{
    if(!p.code && !p.name) return;
    const opt = document.createElement("option");
    opt.value = `${p.code} | ${p.name} | ${p.category}`;
    dl.appendChild(opt);
  });
}

/* ======================= ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ======================= */
function buildEmptyRows(count = 10){
  const tbody = document.getElementById("itemsBody");
  tbody.innerHTML = "";
  for(let i=0;i<count;i++){
    const tr = document.createElement("tr");
    tr.dataset.row = i;
    tr.innerHTML = `
      <td class="col-no">${i+1}</td>
      <td class="col-code item-code"></td>
      <td class="col-desc">
        <input class="product-search"
               list="productList"
               placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå ITEMCODE / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà" />
      </td>
      <td class="col-cat"></td>
      <td class="col-qty">
        <input type="number" min="1" step="1" class="qty-input" value="1" />
      </td>
      <td class="col-unit"></td>
      <td class="col-price">
        <input type="number" step="0.01" class="price-input" />
      </td>
      <td class="col-amount"></td>
    `;
    tbody.appendChild(tr);
  }
}

function findProductFromText(text){
  const q = (text || "").trim().toLowerCase();
  if(!q) return null;

  // 1) ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ITEMCODE ‡∏ï‡∏£‡∏á ‡πÜ
  let p = PRODUCTS.find(p => p.code.toLowerCase() === q);
  if(p) return p;

  // 2) ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏° ‡πÜ
  p = PRODUCTS.find(p => p.name.toLowerCase() === q);
  if(p) return p;

  // 3) ‡∏Ñ‡πâ‡∏ô‡πÅ‡∏ö‡∏ö contains ‡∏à‡∏≤‡∏Å code + name + category
  p = PRODUCTS.find(p => {
    const combo = `${p.code} ${p.name} ${p.category}`.toLowerCase();
    return combo.includes(q);
  });
  return p || null;
}

function fillRowFromProduct(tr, product){
  tr.querySelector(".item-code").textContent   = product.code;
  tr.querySelector(".col-cat").textContent     = product.category;
  tr.querySelector(".col-unit").textContent    = product.unit;

  const qtyInput   = tr.querySelector(".qty-input");
  const priceInput = tr.querySelector(".price-input");

  if(!qtyInput.value || Number(qtyInput.value) <= 0){
    qtyInput.value = 1;
  }
  priceInput.value = product.cost ? product.cost.toFixed(2) : "";

  updateRowAmount(tr);
  updateTotals();
}

function updateRowAmount(tr){
  const qty   = Number(tr.querySelector(".qty-input").value || 0);
  const price = Number(tr.querySelector(".price-input").value || 0);
  const amt   = qty * price;
  tr.querySelector(".col-amount").textContent = amt ? amt.toFixed(2) : "";
}

function updateTotals(){
  let sum = 0;
  document.querySelectorAll("#itemsBody tr").forEach(tr=>{
    const txt = tr.querySelector(".col-amount").textContent || "0";
    const val = Number(txt.replace(/,/g,"")) || 0;
    sum += val;
  });

  const subtotalEl = document.getElementById("subtotal");
  if(subtotalEl) subtotalEl.textContent = sum.toFixed(2);

  const discount = Number(document.getElementById("discountInput").value || 0);
  const deposit  = Number(document.getElementById("depositInput").value || 0);
  const grand = sum - discount - deposit;

  const grandEl = document.getElementById("grandTotal");
  if(grandEl) grandEl.textContent = grand.toFixed(2);
}

/* events ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
function initItemEvents(){
  const tbody = document.getElementById("itemsBody");

  tbody.addEventListener("change", e=>{
    const tr = e.target.closest("tr");
    if(!tr) return;

    if(e.target.classList.contains("product-search")){
      const txt = e.target.value;
      const p = findProductFromText(txt);
      if(p){
        fillRowFromProduct(tr, p);
      }else{
        tr.querySelector(".item-code").textContent = "";
        tr.querySelector(".col-cat").textContent   = "";
        tr.querySelector(".col-unit").textContent  = "";
        updateRowAmount(tr);
        updateTotals();
      }
    }

    if(e.target.classList.contains("qty-input") ||
       e.target.classList.contains("price-input")){
      updateRowAmount(tr);
      updateTotals();
    }
  });

  document.getElementById("discountInput").addEventListener("input", updateTotals);
  document.getElementById("depositInput").addEventListener("input", updateTotals);
}

/* ======================= start ======================= */
window.addEventListener("DOMContentLoaded", ()=>{
  jpInitHeader();
  initQuotationMeta();
  buildEmptyRows(10);
  initItemEvents();
  loadProducts();
});
</script>
</body>
</html>
