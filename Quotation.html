<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Quotation ¬∑ JP Medical So Supply</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{
      margin:0;
      padding:8px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#f5f5f5;
    }
    .page{
      max-width:1120px;
      margin:0 auto;
      background:#fff;
      padding:16px 20px 26px;
      box-shadow:0 2px 8px rgba(0,0,0,.12);
    }
    .top-buttons{
      display:flex;
      gap:10px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:6px 14px;
      font-size:14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:#fff;
      text-decoration:none;
      box-shadow:0 2px 4px rgba(0,0,0,.25);
    }
    .btn-back{background:#6b7280;}
    .btn-print{background:#2563eb;}

    /* header + logo + branch */
    .header-box{
      display:flex;
      align-items:flex-start;
      gap:16px;
      padding:8px 0 14px;
      border-bottom:3px solid #16a34a;
      margin-bottom:10px;
    }
    .header-logo{
      height:70px;
      width:auto;
    }
    .header-text{
      flex:1;
      min-width:0;
    }
    .branch-row{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
      font-size:13px;
      margin-bottom:4px;
    }
    .branch-row label{
      white-space:nowrap;
    }
    #branchSelect{
      font-size:13px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid #cbd5e1;
      background:#f9fafb;
    }
    .header-main{
      font-size:18px;
      font-weight:700;
      color:#14532d;
    }
    .header-sub{
      font-size:14px;
      line-height:1.4;
    }

    h1{
      text-align:center;
      margin:6px 0 2px;
      font-size:22px;
    }
    h2.sub-title{
      text-align:center;
      margin:0 0 10px;
      font-size:18px;
      font-weight:500;
    }

    .info-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .info-block{
      flex:1 1 320px;
      border:1px solid #cbd5e1;
      border-radius:10px;
      padding:6px 10px 8px;
      font-size:14px;
      background:#f9fafb;
    }
    .info-title{
      font-weight:700;
      margin-bottom:4px;
    }
    .editable{
      border-bottom:1px dotted #64748b;
      min-width:40px;
      display:inline-block;
    }

    table.items{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      margin-top:6px;
    }
    table.items th,
    table.items td{
      border:1px solid #444;
      padding:3px 4px;
      vertical-align:top;
      white-space:nowrap;
    }
    table.items th{
      background:#e5f3ff;
      text-align:center;
      font-weight:600;
    }
    .text-right{text-align:right;}

    .cell-input{
      width:100%;
      border:none;
      padding:2px 3px;
      font-family:inherit;
      font-size:14px;
      box-sizing:border-box;
    }
    .cell-input:focus{
      outline:1px solid #60a5fa;
    }

    tfoot td{
      background:#f3f4f6;
      font-weight:600;
    }
    .sum-label{text-align:right;}
    .sum-input{
      width:100%;
      border:none;
      background:transparent;
      text-align:right;
      font-size:14px;
      font-family:inherit;
    }
    .sum-input:focus{
      outline:1px solid #60a5fa;
      background:#fff;
    }

    /* signature section */
    .sign-row{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      margin-top:18px;
      font-size:13px;
    }
    .sign-block{
      flex:1 1 260px;
      border:1px solid #cbd5e1;
      border-radius:10px;
      padding:10px 12px 12px;
      min-height:120px;
    }
    .sign-title{
      font-weight:600;
      margin-bottom:8px;
    }
    .sign-company{
      font-weight:600;
      margin-bottom:6px;
    }
    .sign-line{
      margin:18px 0 2px;
    }
    .sign-line span{
      border-bottom:1px solid #000;
      display:inline-block;
      min-width:180px;
    }
    .sign-label{
      font-size:12px;
      color:#4b5563;
    }

    @media print{
      body{background:#fff;padding:0;}
      .page{box-shadow:none;margin:0;padding:0 8mm;}
      .top-buttons{display:none;}
      @page{
        size:A4 portrait;
        margin:6mm;
      }
    }
  </style>
</head>
<body>
<div class="page">

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
  <div class="top-buttons">
    <a href="ky9.html" class="btn btn-back">‚Üê ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏Ç‡∏¢.9)</a>
    <button class="btn btn-print" onclick="window.print()">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå / PDF</button>
  </div>

  <!-- ‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© + ‡πÇ‡∏•‡πÇ‡∏Å‡πâ + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ -->
  <div class="header-box">
    <!-- ‡∏ñ‡πâ‡∏≤ LOGO.jpg ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ -->
    <img src="LOGO.jpg" alt="JP Medical Logo" class="header-logo">
    <div class="header-text">
      <div class="branch-row">
        <label for="branchSelect">‡∏™‡∏≤‡∏Ç‡∏≤:</label>
        <select id="branchSelect">
          <option value="hq">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà (‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©)</option>
          <option value="chonburi">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ</option>
        </select>
      </div>
      <div id="headerMain" class="header-main"></div>
      <div id="headerSub" class="header-sub"></div>
    </div>
  </div>

  <h1>QUOTATION</h1>
  <h2 class="sub-title">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h2>

  <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ + ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ -->
  <div class="info-row">
    <div class="info-block">
      <div class="info-title">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Customer)</div>
      ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <span class="editable" contenteditable="true"></span><br>
      ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô / ‡∏£‡πâ‡∏≤‡∏ô: <span class="editable" contenteditable="true"></span><br>
      ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: <span class="editable" contenteditable="true"></span><br>
      ‡πÇ‡∏ó‡∏£: <span class="editable" contenteditable="true"></span>
    </div>

    <div class="info-block">
      <div class="info-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</div>
      ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤:
      <span id="quoteNumber" class="editable" contenteditable="true"></span><br>
      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:
      <span id="quoteDate" class="editable" contenteditable="true"></span><br>
      ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:
      <span id="quoteValidUntil" class="editable" contenteditable="true"></span><br>
      ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:
      <span id="contactName" class="editable" contenteditable="true"></span><br>
      ‡πÇ‡∏ó‡∏£:
      <span id="contactPhone" class="editable" contenteditable="true"></span>
    </div>
  </div>

  <!-- datalist dropdown -->
  <datalist id="itemCodeList"></datalist>
  <datalist id="productList"></datalist>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
  <table class="items">
    <thead>
      <tr>
        <th style="width:40px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
        <th style="width:110px;">Item Code</th>
        <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)</th>
        <th style="width:70px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
        <th style="width:80px;">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
        <th style="width:90px;">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
        <th style="width:110px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
      </tr>
    </thead>
    <tbody id="itemBody"></tbody>
    <tfoot>
      <tr>
        <td colspan="5" class="sum-label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (Subtotal)</td>
        <td colspan="2"><input id="sumSubtotal" class="sum-input" type="text" readonly></td>
      </tr>
      <tr>
        <td colspan="5" class="sum-label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (Discount)</td>
        <td colspan="2"><input id="sumDiscount" class="sum-input" type="text" value="0"></td>
      </tr>
      <tr>
        <td colspan="5" class="sum-label">‡∏°‡∏±‡∏î‡∏à‡∏≥ / ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß (Deposit)</td>
        <td colspan="2"><input id="sumDeposit" class="sum-input" type="text" value="0"></td>
      </tr>
      <tr>
        <td colspan="5" class="sum-label">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Total)</td>
        <td colspan="2"><input id="sumTotal" class="sum-input" type="text" readonly></td>
      </tr>
    </tfoot>
  </table>

  <p style="font-size:12px;margin-top:10px;">
    * ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
  </p>

  <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© -->
  <div class="sign-row">
    <div class="sign-block">
      <div class="sign-title">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ</div>
      <div class="sign-line">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ <span></span></div>
      <div class="sign-label">(‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ / Customer)</div>
      <div class="sign-line">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span></span></div>
    </div>

    <div class="sign-block">
      <div class="sign-title">‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏∑‡∏≠</div>
      <div class="sign-company">JP Medical So Supply</div>
      <div class="sign-line">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ <span></span></div>
      <div class="sign-label">(‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ / Prepared by)</div>
      <div style="margin-top:8px;font-size:12px;">
        ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥: ‡∏Ñ‡∏∏‡∏ì‡∏û‡∏±‡∏í‡∏ô‡πå‡∏ô‡∏£‡∏µ<br>
        ‡πÇ‡∏ó‡∏£: 090-413-7894, 090-967-4207
      </div>
    </div>
  </div>

</div>

<script>
/* ============================
   1) CONFIG GOOGLE SHEET ITEM
   ============================ */
const ITEM_SPREADSHEET_ID = "1U4d5PqBMQ1GfTahwvbvzDFQrEikT5sYCOwZIx8FabMI";
const ITEM_GID = "942187814";
const ITEM_URL =
  "https://docs.google.com/spreadsheets/d/" +
  ITEM_SPREADSHEET_ID +
  "/gviz/tq?tqx=out:json&gid=" +
  ITEM_GID;

let allItems = [];

/* mapping columns
   A: product_barcode
   B: product_name
   C: category_desc
   D: unit_desc
   F: cost_price_per_unit
   G: price
*/
function parseItemRow(row){
  const c = row.c || [];
  return {
    barcode:       (c[0] && c[0].v) ? String(c[0].v) : "",
    product_name:  (c[1] && c[1].v) ? String(c[1].v) : "",
    category_desc: (c[2] && c[2].v) ? String(c[2].v) : "",
    unit_desc:     (c[3] && c[3].v) ? String(c[3].v) : "",
    cost_price:    Number(c[5] && c[5].v ? c[5].v : 0),
    price:         Number(c[6] && c[6].v ? c[6].v : 0)
  };
}

function loadItemsFromSheet(){
  fetch(ITEM_URL)
    .then(res => res.text())
    .then(txt => {
      const jsonStr = txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1);
      const data = JSON.parse(jsonStr);
      const rows = data.table.rows || [];
      allItems = rows.map(parseItemRow).filter(it => it.barcode || it.product_name);
      buildItemDatalists();
    })
    .catch(err => {
      console.error("‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
    });
}

/* datalist */
const codeListEl    = document.getElementById("itemCodeList");
const productListEl = document.getElementById("productList");

function buildItemDatalists(){
  codeListEl.innerHTML = "";
  productListEl.innerHTML = "";

  allItems.forEach(it => {
    const optCode = document.createElement("option");
    optCode.value = it.barcode;
    optCode.label = it.barcode + " : " + it.product_name;
    codeListEl.appendChild(optCode);

    const optProd = document.createElement("option");
    optProd.value = it.product_name;
    optProd.label = it.category_desc + " ¬∑ " + it.product_name;
    productListEl.appendChild(optProd);
  });
}

function findItemByCode(code){
  if(!code) return null;
  const k = code.trim().toLowerCase();
  return allItems.find(it => it.barcode.toLowerCase() === k) || null;
}
function findItemByName(name){
  if(!name) return null;
  const k = name.trim().toLowerCase();
  return allItems.find(it => it.product_name.toLowerCase() === k) || null;
}

/* ============================
   2) ‡πÅ‡∏ñ‡∏ß‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
   ============================ */
const itemBody = document.getElementById("itemBody");

function createItemRow(index){
  const tr = document.createElement("tr");
  tr.innerHTML =
    '<td class="text-right">'+ index +'</td>' +
    '<td><input list="itemCodeList" class="cell-input cell-code"></td>' +
    '<td><input list="productList" class="cell-input cell-desc"></td>' +
    '<td><input class="cell-input cell-qty" type="number" min="0" step="0.01"></td>' +
    '<td><input class="cell-input cell-unit"></td>' +
    '<td><input class="cell-input cell-price" type="number" min="0" step="0.01"></td>' +
    '<td><input class="cell-input cell-amount" type="number" step="0.01" readonly></td>';
  attachRowEvents(tr);
  return tr;
}

function buildInitialRows(count){
  itemBody.innerHTML = "";
  for(let i=1;i<=count;i++){
    itemBody.appendChild(createItemRow(i));
  }
}

/* ============================
   3) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î
   ============================ */
const sumSubtotal = document.getElementById("sumSubtotal");
const sumDiscount = document.getElementById("sumDiscount");
const sumDeposit  = document.getElementById("sumDeposit");
const sumTotal    = document.getElementById("sumTotal");

function parseNumber(val){
  if(typeof val !== "string") val = String(val ?? "");
  val = val.replace(/,/g,"");
  const n = parseFloat(val);
  return isNaN(n) ? 0 : n;
}

function recalcRowAmount(tr){
  const qtyInput   = tr.querySelector(".cell-qty");
  const priceInput = tr.querySelector(".cell-price");
  const amountInput= tr.querySelector(".cell-amount");

  const qty   = parseNumber(qtyInput.value);
  const price = parseNumber(priceInput.value);
  const amount= qty * price;

  amountInput.value = amount ? amount.toFixed(2) : "";
}

function recalcTotals(){
  let subtotal = 0;
  itemBody.querySelectorAll("tr").forEach(tr=>{
    const amountInput = tr.querySelector(".cell-amount");
    subtotal += parseNumber(amountInput.value);
    });

  const discount = parseNumber(sumDiscount.value);
  const deposit  = parseNumber(sumDeposit.value);
  const total    = subtotal - discount - deposit;

  sumSubtotal.value = subtotal ? subtotal.toFixed(2) : "";
  sumTotal.value    = total    ? total.toFixed(2)    : "";
}

/* ============================
   4) Events ‡πÅ‡∏ñ‡∏ß
   ============================ */
function autoFillFromItem(tr, item){
  if(!item) return;

  const codeInput  = tr.querySelector(".cell-code");
  const descInput  = tr.querySelector(".cell-desc");
  const unitInput  = tr.querySelector(".cell-unit");
  const priceInput = tr.querySelector(".cell-price");
  const qtyInput   = tr.querySelector(".cell-qty");

  codeInput.value  = item.barcode;
  descInput.value  = item.product_name;
  unitInput.value  = item.unit_desc;
  priceInput.value = item.cost_price ? item.cost_price.toFixed(2) : "";

  if(!parseNumber(qtyInput.value)){
    qtyInput.value = "1";
  }
  recalcRowAmount(tr);
  recalcTotals();
}

function attachRowEvents(tr){
  const codeInput  = tr.querySelector(".cell-code");
  const descInput  = tr.querySelector(".cell-desc");
  const qtyInput   = tr.querySelector(".cell-qty");
  const priceInput = tr.querySelector(".cell-price");

  codeInput.addEventListener("change", ()=>{
    const it = findItemByCode(codeInput.value);
    autoFillFromItem(tr, it);
  });

  descInput.addEventListener("change", ()=>{
    const it = findItemByName(descInput.value);
    autoFillFromItem(tr, it);
  });

  [qtyInput, priceInput].forEach(inp=>{
    inp.addEventListener("input", ()=>{
      recalcRowAmount(tr);
      recalcTotals();
    });
  });
}

[sumDiscount, sumDeposit].forEach(inp=>{
  inp.addEventListener("input", recalcTotals);
});

/* ============================
   5) Header: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / +30 ‡∏ß‡∏±‡∏ô / run no
   ============================ */
const quoteNumberEl  = document.getElementById("quoteNumber");
const quoteDateEl    = document.getElementById("quoteDate");
const quoteValidEl   = document.getElementById("quoteValidUntil");
const contactNameEl  = document.getElementById("contactName");
const contactPhoneEl = document.getElementById("contactPhone");

function formatDate(d){
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return dd + "/" + mm + "/" + yy;
}

function genRunningNo(){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm   = String(today.getMonth()+1).padStart(2,"0");
  const key  = "QT-" + yyyy + mm + "-RUN";
  let run = localStorage.getItem(key);
  if(!run) run = 1;
  else run = Number(run) + 1;
  localStorage.setItem(key, run);
  const runStr = String(run).padStart(3,"0");
  return "QT-" + yyyy + mm + "-" + runStr;
}

function initHeader(){
  const today = new Date();
  const valid = new Date(today);
  valid.setDate(valid.getDate()+30);

  if(!quoteDateEl.textContent.trim()){
    quoteDateEl.textContent = formatDate(today);
  }
  if(!quoteValidEl.textContent.trim()){
    quoteValidEl.textContent = formatDate(valid);
  }
  if(!quoteNumberEl.textContent.trim()){
    quoteNumberEl.textContent = genRunningNo();
  }
  if(!contactNameEl.textContent.trim()){
    contactNameEl.textContent = "‡∏Ñ‡∏∏‡∏ì‡∏û‡∏±‡∏í‡∏ô‡πå‡∏ô‡∏£‡∏µ";
  }
  if(!contactPhoneEl.textContent.trim()){
    contactPhoneEl.textContent = "090-413-7894, 090-967-4207";
  }
}

/* ============================
   6) Branch selector (HQ / ‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ)
   ============================ */
const headerMainEl = document.getElementById("headerMain");
const headerSubEl  = document.getElementById("headerSub");
const branchSelect = document.getElementById("branchSelect");

const BRANCHES = {
  hq:{
    name:"‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÄ‡∏à‡∏û‡∏µ ‡πÄ‡∏°‡∏î‡∏¥‡∏Ñ‡∏≠‡∏• ‡πÇ‡∏ã ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢ (‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà)",
    addr:"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 871/1 ‡∏ñ‡∏ô‡∏ô‡∏≠‡∏∏‡∏ö‡∏• ‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÉ‡∏ï‡πâ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏© 33000",
    tel:"‡πÇ‡∏ó‡∏£ 090-413-7894, 090-967-4207"
  },
  chonburi:{
    name:"‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÄ‡∏à‡∏û‡∏µ ‡πÄ‡∏°‡∏î‡∏¥‡∏Ñ‡∏≠‡∏• ‡πÇ‡∏ã ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢ (‡∏™‡∏≤‡∏Ç‡∏≤‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ)",
    addr:"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 51/49 ‡∏ñ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó ‡∏´‡∏°‡∏π‡πà 4 ‡∏ï‡∏≥‡∏ö‡∏•‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏ß‡∏ô ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ 20000",
    tel:"‡πÇ‡∏ó‡∏£ 090-413-7894, 090-967-4207"
  }
};

function applyBranch(branchKey){
  const b = BRANCHES[branchKey] || BRANCHES.hq;
  headerMainEl.textContent = b.name;
  headerSubEl.innerHTML = b.addr + "<br>" + b.tel;
  try{
    localStorage.setItem("JP_BRANCH", branchKey);
  }catch(e){}
}

/* ============================
   7) init ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤
   ============================ */
function initPage(){
  // restore branch from localStorage
  let savedBranch = "hq";
  try{
    const v = localStorage.getItem("JP_BRANCH");
    if(v && BRANCHES[v]) savedBranch = v;
  }catch(e){}
  branchSelect.value = savedBranch;
  applyBranch(savedBranch);

  buildInitialRows(10);
  loadItemsFromSheet();
  initHeader();
  recalcTotals();

  branchSelect.addEventListener("change", ()=>{
    applyBranch(branchSelect.value);
  });
}

window.addEventListener("DOMContentLoaded", initPage);
</script>
</body>
</html>
