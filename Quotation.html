<script>
/* ============================
   1) CONFIG GOOGLE SHEET ITEM
   ============================ */

// ชีตที่เก็บ item ทั้งหมด
const ITEM_SPREADSHEET_ID = "1U4d5PqBMQ1GfTahwvbvzDFQrEikT5sYCOwZIx8FabMI";
const ITEM_GID = "942187814";
const ITEM_URL =
  `https://docs.google.com/spreadsheets/d/${ITEM_SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${ITEM_GID}`;

let allItems = [];

/*
  ปรับ index คอลัมน์ให้ตรงกับชีตจริงถ้าจำเป็น:

  c[0] = item_code
  c[1] = product_name
  c[2] = unit_desc
  c[3] = cost_price_per_unit
  c[4] = category_desc
*/
function parseItemRow(row) {
  const c = row.c || [];
  return {
    item_code: (c[0]?.v || "").toString(),
    product_name: (c[1]?.v || "").toString(),
    unit_desc: (c[2]?.v || "").toString(),
    cost_price_per_unit: Number(c[3]?.v ?? 0),
    category_desc: (c[4]?.v || "").toString()
  };
}

function loadItemsFromSheet() {
  fetch(ITEM_URL)
    .then(res => res.text())
    .then(txt => {
      const jsonStr = txt.substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1);
      const data = JSON.parse(jsonStr);
      const rows = data.table.rows || [];
      allItems = rows.map(parseItemRow)
                     .filter(it => it.item_code || it.product_name);

      buildItemDatalists();
    })
    .catch(err => {
      console.error("โหลด Item จากชีตไม่สำเร็จ:", err);
    });
}

/* datalist: 1) code  2) category+ชื่อสินค้า */
const codeListEl    = document.getElementById("itemCodeList");
const productListEl = document.getElementById("productList");

function buildItemDatalists() {
  if (codeListEl)    codeListEl.innerHTML    = "";
  if (productListEl) productListEl.innerHTML = "";

  allItems.forEach(it => {
    if (codeListEl) {
      const opt = document.createElement("option");
      opt.value = it.item_code;
      opt.label = `${it.item_code} : ${it.product_name}`;
      codeListEl.appendChild(opt);
    }
    if (productListEl) {
      const opt2 = document.createElement("option");
      opt2.value = it.product_name; // ใช้ชื่อสินค้าเป็นค่าที่เลือก
      opt2.label = `${it.category_desc} · ${it.product_name}`;
      productListEl.appendChild(opt2);
    }
  });
}

function findItemByCode(code) {
  if (!code) return null;
  const c = code.trim().toLowerCase();
  return allItems.find(it => it.item_code.toLowerCase() === c) || null;
}

function findItemByName(name) {
  if (!name) return null;
  const n = name.trim().toLowerCase();
  return allItems.find(it => it.product_name.toLowerCase() === n) || null;
}

/* ============================
   2) แถวรายการสินค้า
   ============================ */

const itemBody = document.getElementById("itemBody");

function createItemRow(index) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="text-right">${index}</td>
    <td><input list="itemCodeList" class="cell-input cell-code"></td>
    <td><input list="productList" class="cell-input cell-desc"></td>
    <td><input class="cell-input cell-qty" type="number" min="0" step="0.01"></td>
    <td><input class="cell-input cell-unit"></td>
    <td><input class="cell-input cell-price" type="number" min="0" step="0.01"></td>
    <td><input class="cell-input cell-amount" type="number" step="0.01"></td>
  `;
  attachRowEvents(tr);
  return tr;
}

function buildInitialRows(count = 10) {
  itemBody.innerHTML = "";
  for (let i = 1; i <= count; i++) {
    itemBody.appendChild(createItemRow(i));
  }
}

/* ============================
   3) การคำนวณ
   ============================ */

const sumSubtotal = document.getElementById("sumSubtotal");
const sumDiscount = document.getElementById("sumDiscount");
const sumDeposit  = document.getElementById("sumDeposit");
const sumRemain   = document.getElementById("sumRemain");
const sumTotal    = document.getElementById("sumTotal");

function parseNumber(val) {
  if (typeof val !== "string") val = String(val ?? "");
  val = val.replace(/,/g, "");
  const n = parseFloat(val);
  return isNaN(n) ? 0 : n;
}

function recalcRowAmount(tr) {
  const qtyInput    = tr.querySelector(".cell-qty");
  const priceInput  = tr.querySelector(".cell-price");
  const amountInput = tr.querySelector(".cell-amount");

  const qty   = parseNumber(qtyInput.value);
  const price = parseNumber(priceInput.value);
  const amount = qty * price;

  amountInput.value = amount ? amount.toFixed(2) : "";
}

function recalcTotals() {
  let subtotal = 0;
  const rows = itemBody.querySelectorAll("tr");
  rows.forEach(tr => {
    const amountInput = tr.querySelector(".cell-amount");
    const val = parseNumber(amountInput.value);
    subtotal += val;
  });

  const discount = parseNumber(sumDiscount.value);
  const deposit  = parseNumber(sumDeposit.value);

  const remain = subtotal - discount - deposit;
  const total  = remain;

  sumSubtotal.value = subtotal ? subtotal.toFixed(2) : "";
  sumRemain.value   = remain   ? remain.toFixed(2)   : "";
  sumTotal.value    = total    ? total.toFixed(2)    : "";
}

/* ============================
   4) Event ของแต่ละแถว
   ============================ */

function autoFillFromItem(tr, item) {
  const codeInput  = tr.querySelector(".cell-code");
  const descInput  = tr.querySelector(".cell-desc");
  const unitInput  = tr.querySelector(".cell-unit");
  const priceInput = tr.querySelector(".cell-price");
  const qtyInput   = tr.querySelector(".cell-qty");

  if (!item) return;

  codeInput.value  = item.item_code;
  descInput.value  = item.product_name;
  unitInput.value  = item.unit_desc;
  priceInput.value = item.cost_price_per_unit
    ? item.cost_price_per_unit.toFixed(2)
    : "";

  // ถ้ายังไม่เคยใส่จำนวน ให้เริ่มต้นเป็น 1
  const currentQty = parseNumber(qtyInput.value);
  if (!currentQty) qtyInput.value = "1";

  recalcRowAmount(tr);
  recalcTotals();
}

function attachRowEvents(tr) {
  const codeInput   = tr.querySelector(".cell-code");
  const descInput   = tr.querySelector(".cell-desc");
  const unitInput   = tr.querySelector(".cell-unit");
  const priceInput  = tr.querySelector(".cell-price");
  const qtyInput    = tr.querySelector(".cell-qty");

  // เลือกจาก Item Code
  codeInput.addEventListener("change", () => {
    const item = findItemByCode(codeInput.value);
    autoFillFromItem(tr, item);
  });

  // เลือกจาก dropdown รายละเอียดสินค้า (category_desc + product_name)
  descInput.addEventListener("change", () => {
    const item = findItemByName(descInput.value);
    autoFillFromItem(tr, item);
  });

  // เปลี่ยนจำนวน/ราคา → คำนวณใหม่
  [qtyInput, priceInput].forEach(inp => {
    inp.addEventListener("input", () => {
      recalcRowAmount(tr);
      recalcTotals();
    });
  });
}

/* ============================
   5) ส่วนลด/มัดจำ เปลี่ยน → คำนวณใหม่
   ============================ */

[sumDiscount, sumDeposit].forEach(inp => {
  if (!inp) return;
  inp.addEventListener("input", () => {
    recalcTotals();
  });
});

/* ============================
   6) AUTO DATE / RUN NO / VALID +30
   ============================ */

const quoteNumberEl  = document.getElementById("quoteNumber");
const quoteDateEl    = document.getElementById("quoteDate");
const quoteValidEl   = document.getElementById("quoteValidUntil");
const contactNameEl  = document.getElementById("contactName");
const contactPhoneEl = document.getElementById("contactPhone");

function formatDateDDMMYYYY(d) {
  const dd = String(d.getDate()).padStart(2, "0");
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const yyyy = d.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}

function generateRunningQuotationNumber() {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm   = String(today.getMonth() + 1).padStart(2, "0");
  const key  = `QT-${yyyy}${mm}-RUN`;

  let run = localStorage.getItem(key);
  if (!run) run = 1;
  else run = Number(run) + 1;

  localStorage.setItem(key, run);
  return `QT-${yyyy}${mm}-${String(run).padStart(3, "0")}`;
}

function initHeaderDefaults() {
  const today = new Date();
  const todayStr = formatDateDDMMYYYY(today);

  const valid = new Date(today);
  valid.setDate(valid.getDate() + 30);
  const validStr = formatDateDDMMYYYY(valid);

  if (quoteDateEl && !quoteDateEl.textContent.trim()) {
    quoteDateEl.textContent = todayStr;
  }
  if (quoteValidEl && !quoteValidEl.textContent.trim()) {
    quoteValidEl.textContent = validStr;
  }
  if (quoteNumberEl && !quoteNumberEl.textContent.trim()) {
    quoteNumberEl.textContent = generateRunningQuotationNumber();
  }

  if (contactNameEl && !contactNameEl.textContent.trim()) {
    contactNameEl.textContent = "คุณพัฒน์นรี";
  }
  if (contactPhoneEl && !contactPhoneEl.textContent.trim()) {
    contactPhoneEl.textContent = "090-413-7894, 090-967-4207";
  }
}

/* ============================
   7) init ทั้งหมด
   ============================ */

function initPage() {
  buildInitialRows(10);
  loadItemsFromSheet();
  initHeaderDefaults();
  recalcTotals();
}

window.addEventListener("DOMContentLoaded", initPage);
</script>
