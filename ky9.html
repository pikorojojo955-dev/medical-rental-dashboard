<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>บัญชีการซื้อยา (ขย.9) | JP Pharmacy</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 1.4rem;
    }
    .subtitle {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 16px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
      font-size: 0.9rem;
    }
    .toolbar label {
      margin-right: 4px;
    }
    .toolbar input {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
    }
    thead {
      background: #00c853;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
      vertical-align: top;
      white-space: nowrap;
    }
    tbody tr:nth-child(even) {
      background: #fafafa;
    }
    .loading {
      font-size: 0.9rem;
      color: #777;
    }
    .error {
      font-size: 0.9rem;
      color: #b71c1c;
      margin-top: 8px;
    }
    @media (max-width: 768px) {
      table {
        font-size: 0.8rem;
      }
      th, td {
        padding: 4px 6px;
      }
    }
  </style>
</head>
<body>
  <h1>บัญชีการซื้อยา (ขย.9)</h1>
  <div class="subtitle">
    ดึงข้อมูลจาก Google Sheet แบบอ่านอย่างเดียว
  </div>

  <div class="card">
    <div class="toolbar">
      <div>
        <label for="searchText">ค้นหาชื่อยา / LOT / ITEMCODE:</label>
        <input id="searchText" type="text" placeholder="เช่น Yasmin, 1234, DIANE…" />
      </div>
    </div>

    <div id="loading" class="loading">กำลังดึงข้อมูลจาก Google Sheet…</div>
    <div id="error" class="error" style="display:none;"></div>

    <table id="ky9Table" style="display:none;">
      <thead>
        <tr>
          <th>ลำดับที่</th>
          <th>วันที่รับสินค้า</th>
          <th>ชื่อผู้ขาย</th>
          <th>ITEMCODE</th>
          <th>ชื่อยา</th>
          <th>เลขที่/อักษร ครั้งที่ผลิต (LOT)</th>
          <th>จำนวน/ปริมาณ</th>
          <th>หน่วย</th>
          <th>ลายมือชื่อผู้มีหน้าที่ปฏิบัติการ</th>
          <th>หมายเหตุ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // ข้อมูลชีตของคุณ
    const SPREADSHEET_ID = "1Fqq6zxoM8Qw-hNbl5U7hwmezdzxT32ek43qX70uQAZc";
    const GID = "136320859";

    const SHEET_URL =
      `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;

    let allRows = []; // เก็บข้อมูลไว้สำหรับค้นหา

    async function loadKy9() {
      const loadingEl = document.getElementById("loading");
      const errorEl = document.getElementById("error");
      const tableEl = document.getElementById("ky9Table");
      const tbody = tableEl.querySelector("tbody");

      try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();

        // gviz จะห่อ JSON ด้วยข้อความอื่น ต้องตัดออก
        const jsonStr = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
        const data = JSON.parse(jsonStr);

        const rows = data.table.rows || [];
        allRows = rows; // เก็บไว้สำหรับ filter

        renderTable(rows);

        loadingEl.style.display = "none";
        tableEl.style.display = "table";
      } catch (err) {
        console.error(err);
        loadingEl.style.display = "none";
        errorEl.style.display = "block";
        errorEl.textContent = "ดึงข้อมูลจาก Google Sheet ไม่สำเร็จ กรุณาตรวจสอบสิทธิ์การแชร์ หรือค่า SPREADSHEET_ID / gid";
      }
    }

    function renderTable(rows) {
      const tableEl = document.getElementById("ky9Table");
      const tbody = tableEl.querySelector("tbody");
      tbody.innerHTML = "";

      rows.forEach((row) => {
        const c = row.c || [];

        // map คอลัมน์ตาม ขย9:
        // 0: ลำดับที่
        // 1: วันที่รับสินค้า
        // 2: ชื่อผู้ขาย
        // 3: ITEMCODE
        // 4: ชื่อยา
        // 5: เลขที่หรืออักษรครั้งที่ผลิต
        // 6: จำนวน/ปริมาณ
        // 7: หน่วย
        // 8: ลายมือชื่อผู้มีหน้าที่ปฏิบัติการ
        // 9: หมายเหตุ

        const no        = c[0]?.v ?? "";
        const dateIn    = c[1]?.f || c[1]?.v || "";
        const vendor    = c[2]?.v ?? "";
        const itemCode  = c[3]?.v ?? "";
        const drugName  = c[4]?.v ?? "";
        const lot       = c[5]?.v ?? "";
        const qty       = c[6]?.v ?? "";
        const unit      = c[7]?.v ?? "";
        const signer    = c[8]?.v ?? "";
        const remark    = c[9]?.v ?? "";

        // ถ้าแถวว่างเกินไป ข้ามได้
        if (!itemCode && !drugName && !lot) return;

        const tr = document.createElement("tr");

        function addCell(text) {
          const td = document.createElement("td");
          td.textContent = text;
          tr.appendChild(td);
        }

        addCell(no);
        addCell(dateIn);
        addCell(vendor);
        addCell(itemCode);
        addCell(drugName);
        addCell(lot);
        addCell(qty);
        addCell(unit);
        addCell(signer);
        addCell(remark);

        tbody.appendChild(tr);
      });
    }

    // ฟังก์ชันค้นหาแบบง่ายๆ จากชื่อยา / LOT / ITEMCODE
    function setupSearch() {
      const input = document.getElementById("searchText");
      input.addEventListener("input", () => {
        const keyword = input.value.trim().toLowerCase();
        if (!keyword) {
          renderTable(allRows);
          return;
        }
        const filtered = allRows.filter((row) => {
          const c = row.c || [];
          const itemCode = (c[3]?.v ?? "").toString().toLowerCase();
          const drug     = (c[4]?.v ?? "").toString().toLowerCase();
          const lot      = (c[5]?.v ?? "").toString().toLowerCase();
          return (
            itemCode.includes(keyword) ||
            drug.includes(keyword) ||
            lot.includes(keyword)
          );
        });
        renderTable(filtered);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      setupSearch();
      loadKy9();
    });
  </script>
</body>
</html>
